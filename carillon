#!/usr/bin/env python3
import json
import os
import signal
import subprocess
import sys

import urwid


class CarillonDisplay:
    def __init__(self):
        self.title = urwid.Edit('Title: ')
        self.composer = urwid.Edit('Composer: ')
        self.live = urwid.CheckBox('Live')

        self.update_button = urwid.Button('Update', self.update)
        self.clear_button = urwid.Button('Clear', self.clear)
        self.buttons = urwid.Columns([(10, self.update_button), urwid.Divider(), (9, self.clear_button)])

        self.pile = urwid.Pile([self.title, self.composer, self.live, urwid.Divider(), self.buttons])

        self.loop = urwid.MainLoop(urwid.Filler(urwid.Padding(self.pile, width=40, align='center')))

        self.clear()
        self.refresh()

    def run(self):
        self.loop.run()

    def exit(self):
        raise urwid.ExitMainLoop()

    def refresh(self, _=None, __=None):
        with open(os.path.dirname(__file__) + '/www/details.json', 'r') as file:
            data = json.loads(file.read())
            self.live.state = data['live']
            self.title.edit_text = data['title']
            self.composer.edit_text = data['composer']

        self.loop.set_alarm_in(2, self.refresh)

    def update(self, _=None):
        with open(os.path.dirname(__file__) + '/www/details.json', 'w') as file:
            file.write(json.dumps({'live': self.live.state, 'title': self.title.edit_text, 'composer': self.composer.edit_text}))

    def clear(self, _=None):
        self.title.set_edit_text('None')
        self.composer.set_edit_text('None')
        self.live.set_state(False)

        self.update(_)


nginx_cmd = ['/usr/sbin/nginx', '-p', os.path.dirname(__file__), '-c', os.path.dirname(__file__) + '/conf/nginx.conf']
ffserver_cmd = ['/usr/bin/ffserver', '-f', os.path.dirname(__file__) + '/conf/ffserver.conf']
update_cmd = ['/bin/sh', '-c', 'cd ' + os.path.dirname(__file__) + '/upd && npm install && exec npm start']


if __name__ == '__main__':
    try:
        nginx = subprocess.Popen(nginx_cmd, stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)
        ffserver = subprocess.Popen(ffserver_cmd, stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)
        update = subprocess.Popen(update_cmd, stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)

        display = CarillonDisplay()

        signal.signal(signal.SIGINT, lambda signum, siginfo: display.exit())
        signal.signal(signal.SIGTERM, lambda signum, siginfo: display.exit())
        signal.signal(signal.SIGCHLD, lambda signum, siginfo: display.exit())

        display.run()
    finally:
        try:
            if nginx.poll():
                sys.stderr.write('nginx returned an error\n')
            else:
                nginx.terminate()
                nginx.wait()
        except:
            None
        try:
            if ffserver.poll():
                sys.stderr.write('ffserver returned an error\n')
            else:
                ffserver.terminate()
                ffserver.wait()
        except:
            None
        try:
            if update.poll():
                sys.stderr.write('updater application returned an error\n')
            else:
                update.terminate()
                update.wait()
        except:
            None
